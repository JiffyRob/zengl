<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body class="example">
  <canvas id="zengl-canvas", tabindex="1" width="1280" height="720"></canvas>
</body>
<script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
<script src="zengl_canvas.js"></script>
<script src="zengl_webgl.js"></script>
<script>
  (async () => {
    const pyodide = await loadPyodide();

    await pyodide.loadPackage([
      'numpy',
      'zengl-1.13.0-cp311-cp311-emscripten_3_1_32_wasm32.whl',
      'zengl_webgl-0.1.0-cp311-cp311-emscripten_3_1_32_wasm32.whl',
      'zengl_canvas-0.1.0-cp311-cp311-emscripten_3_1_32_wasm32.whl',
    ]);

    const canvas = document.getElementById('zengl-canvas');
    const gl = canvas.getContext('webgl2', {
      alpha: false, depth: false, stencil: false, antialias: false,
      premultipliedAlpha: false, preserveDrawingBuffer: false,
      powerPreference: 'high-performance',
    });

    zenglCanvasSetup(pyodide, canvas);
    zenglSetup(pyodide._module, gl);

    pyodide.runPython(document.getElementById('python').innerHTML);
  })();
</script>
<script id="python" type="application/x-python-code">
  import struct

  import numpy as np
  import zengl
  import zengl_canvas
  import zengl_webgl

  wnd = zengl_canvas.window
  ctx = zengl.context(zengl_webgl.Loader())

  temp = ctx.image(wnd.size, 'rgba8unorm', texture=False)
  image = ctx.image(wnd.size, 'rgba8unorm', samples=4)
  image.clear_value = (0.0, 0.0, 0.0, 1.0)

  uniform_buffer = ctx.buffer(size=16)

  vertex_buffer = ctx.buffer(np.array([
      1.0, 0.0,
      1.0, 0.0, 0.0, 0.5,

      -0.5, 0.86,
      0.0, 1.0, 0.0, 0.5,

      -0.5, -0.86,
      0.0, 0.0, 1.0, 0.5,
  ], 'f4'))

  triangle = ctx.pipeline(
      vertex_shader='''
          #version 300 es
          precision highp float;

          layout (std140) uniform Common {
              vec2 scale;
              float rotation;
          };

          layout (location = 0) in vec2 in_vert;
          layout (location = 1) in vec4 in_color;

          out vec4 v_color;

          void main() {
              float r = rotation * (0.5 + float(gl_InstanceID) * 0.05);
              mat2 rot = mat2(cos(r), sin(r), -sin(r), cos(r));
              gl_Position = vec4((rot * in_vert) * scale, 0.0, 1.0);
              v_color = in_color;
          }
      ''',
      fragment_shader='''
          #version 300 es
          precision highp float;

          in vec4 v_color;

          layout (location = 0) out vec4 out_color;

          void main() {
              out_color = vec4(pow(v_color.rgb, vec3(1.0 / 2.2)), v_color.a);
          }
      ''',
      layout=[
          {
              'name': 'Common',
              'binding': 0,
          },
      ],
      resources=[
          {
              'type': 'uniform_buffer',
              'binding': 0,
              'buffer': uniform_buffer,
          },
      ],
      blend={
          'enable': True,
          'src_color': 'src_alpha',
          'dst_color': 'one_minus_src_alpha',
      },
      framebuffer=[image],
      topology='triangles',
      vertex_buffers=zengl.bind(vertex_buffer, '2f 4f', 0, 1),
      vertex_count=3,
      instance_count=10,
  )


  def render():
      ctx.new_frame()
      image.clear()
      uniform_buffer.write(struct.pack('3f4x', 0.5, 0.5 * wnd.aspect, wnd.time))
      triangle.render()
      image.blit(temp)
      temp.blit()
      ctx.end_frame()
</script>
</html>
