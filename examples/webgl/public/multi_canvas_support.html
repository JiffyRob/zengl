<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="favicon.png">
  <title>ZenGL Examples</title>
  <style>
    #root {
      margin: auto;
      max-width: 800px;
      justify-content: center;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
  </style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/pyodide/v0.22.1/full/pyodide.js"></script>
<script src="webgl.js"></script>
<div id="root"></div>
<script>
  (async () => {
    const pyodide = await loadPyodide();
    window.pyodide = pyodide;
    window.wasm = pyodide._module;

    await pyodide.loadPackage([
      'zengl-1.12.0-cp310-cp310-emscripten_3_1_27_wasm32.whl',
      'webgl-0.1.0-cp310-cp310-emscripten_3_1_27_wasm32.whl',
    ]);

    pyodide._module.mergeLibSymbols(zenglSymbols(pyodide._module));

    pyodide.runPython(document.getElementById('python').innerHTML);
  })();
</script>
<script id="python" type="application/x-python-code">
  import struct

  import webgl
  import zengl


  class Triangle:
      def __init__(self, color, speed):
          self.speed = speed
          self.window = webgl.window((256, 256), 'root')
          self.window.render(self.render)
          self.ctx = zengl.context(self.window)

          self.image = self.ctx.image(self.window.size, 'rgba8unorm', texture=False)
          self.image.clear_value = (0.0, 0.0, 0.0, 1.0)

          self.pipeline = self.ctx.pipeline(
              vertex_shader='''
                  #version 300 es
                  precision highp float;

                  vec2 positions[3] = vec2[](
                      vec2(1.0, 0.0),
                      vec2(-0.5, -0.86),
                      vec2(-0.5, 0.86)
                  );

                  uniform float time;
                  uniform vec2 scale;

                  void main() {
                      mat2 rot = mat2(cos(time), sin(time), -sin(time), cos(time));
                      gl_Position = vec4(rot * positions[gl_VertexID] * scale, 0.0, 1.0);
                  }
              ''',
              fragment_shader='''
                  #version 300 es
                  precision highp float;

                  uniform vec3 color;

                  layout (location = 0) out vec4 out_color;

                  void main() {
                      out_color = vec4(pow(color, vec3(1.0 / 2.2)), 1.0);
                  }
              ''',
              framebuffer=[self.image],
              uniforms={
                  'time': 0.0,
                  'scale': (0.8 / self.window.aspect, 0.8),
                  'color': color,
              },
              topology='triangles',
              vertex_count=3,
          )

      def render(self):
          self.ctx.new_frame()
          self.image.clear()
          self.pipeline.uniforms['time'][:] = struct.pack('f', self.window.time * self.speed)
          self.pipeline.render()
          self.image.blit()
          self.ctx.end_frame()


  triangles = [
    Triangle((1.0, 0.0, 0.0), 1.0),
    Triangle((0.0, 1.0, 0.0), 0.8),
    Triangle((0.0, 0.0, 1.0), -1.1),
    Triangle((0.0, 1.0, 1.0), -1.2),
    Triangle((1.0, 0.0, 1.0), 0.7),
    Triangle((1.0, 1.0, 0.0), -0.9),
  ]
</script>
</body>
</html>
